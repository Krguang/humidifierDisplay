#include "display.h"
#include "white12864.h"
#include "dataProcessing.h"
#include "hal_key.h"

uint8_t powerOn = 1;
int8_t displayCount = 1;

const uint8_t num0[] = { 

	0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0x40,0x40,0x40,0x80,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0xF0,0xFE,0x0F,0x01,0x00,0x00,0x00,0x00,0x01,0x07,0xFE,0xF0,0x00,0x00,
	0x00,0x00,0x3F,0xFF,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xFF,0x3F,0x00,0x00,
	0x00,0x00,0x00,0x01,0x03,0x06,0x0C,0x08,0x08,0x08,0x06,0x03,0x01,0x00,0x00,0x00/*"0",0*/
};

const uint8_t num1[] = {

	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x01,0x01,0x01,0x01,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x08,0x08,0x08,0x0C,0x0F,0x0F,0x0C,0x08,0x08,0x08,0x00,0x00,0x00/*"1",1*/
};

const uint8_t num2[] = {

	0x00,0x00,0x00,0x00,0x80,0x40,0x40,0x40,0x40,0x40,0xC0,0x80,0x80,0x00,0x00,0x00,
	0x00,0x00,0x1E,0x19,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC1,0xFF,0x3E,0x00,0x00,
	0x00,0x00,0x00,0x00,0x80,0x40,0x30,0x18,0x0C,0x06,0x03,0x01,0x00,0xC0,0x00,0x00,
	0x00,0x00,0x0E,0x0D,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0E,0x03,0x00,0x00/*"2",2*/
};

const uint8_t num3[] = {

	0x00,0x00,0x00,0x80,0x80,0x40,0x40,0x40,0x40,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x0F,0x0F,0x00,0x00,0x00,0x00,0x00,0x80,0xC1,0x7F,0x3E,0x00,0x00,0x00,
	0x00,0x00,0xC0,0xC0,0x00,0x00,0x01,0x01,0x01,0x03,0x02,0x06,0xFC,0xF0,0x00,0x00,
	0x00,0x00,0x03,0x07,0x04,0x08,0x08,0x08,0x08,0x08,0x04,0x06,0x03,0x00,0x00,0x00/*"3",3*/
};

const uint8_t num4[] = {

	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x80,0x60,0x10,0x0C,0x03,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,
	0x00,0x30,0x2C,0x26,0x21,0x20,0x20,0x20,0x20,0xFF,0xFF,0x20,0x20,0x20,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x0F,0x0F,0x08,0x08,0x08,0x00,0x00/*"4",4*/
};

const uint8_t num5[] = {

	0x00,0x00,0x00,0x00,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0x00,0x00,
	0x00,0x00,0x00,0xFF,0x00,0x80,0x40,0x40,0x40,0x40,0xC0,0x80,0x00,0x00,0x00,0x00,
	0x00,0x00,0xC0,0xC3,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0xFF,0xFC,0x00,0x00,
	0x00,0x00,0x03,0x04,0x04,0x08,0x08,0x08,0x08,0x08,0x04,0x07,0x03,0x00,0x00,0x00/*"5",5*/
};

const uint8_t num6[] = {

	0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x40,0x40,0x40,0x40,0x80,0x80,0x00,0x00,0x00,
	0x00,0x00,0xE0,0xFC,0x07,0x81,0xC0,0x40,0x40,0x40,0xC0,0x83,0x03,0x00,0x00,0x00,
	0x00,0x00,0x7F,0xFF,0x83,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0xFF,0xFC,0x00,0x00,
	0x00,0x00,0x00,0x01,0x07,0x06,0x0C,0x08,0x08,0x08,0x0C,0x06,0x03,0x00,0x00,0x00/*"6",6*/
};

const uint8_t num7[] = {

	0x00,0x00,0x00,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0x00,0x00,
	0x00,0x00,0x0E,0x03,0x00,0x00,0x00,0x00,0x00,0xE0,0x18,0x06,0x01,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xFC,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0x0F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00/*"7",7*/
};

const uint8_t num8[] = {

	0x00,0x00,0x00,0x00,0x80,0xC0,0x40,0x40,0x40,0x40,0xC0,0x80,0x00,0x00,0x00,0x00,
	0x00,0x00,0x3E,0x7F,0xF1,0xC0,0xC0,0x80,0x00,0x00,0x80,0x41,0x7F,0x1E,0x00,0x00,
	0x00,0xF0,0xFC,0x0E,0x02,0x01,0x01,0x01,0x03,0x07,0x0E,0x1E,0xFC,0xF0,0x00,0x00,
	0x00,0x01,0x03,0x06,0x04,0x08,0x08,0x08,0x08,0x08,0x04,0x06,0x03,0x01,0x00,0x00/*"8",8*/
};

const uint8_t num9[] = {

	0x00,0x00,0x00,0x80,0x80,0x40,0x40,0x40,0x40,0x40,0x80,0x00,0x00,0x00,0x00,0x00,
	0x00,0xFC,0xFF,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xFE,0xF8,0x00,0x00,
	0x00,0x01,0x03,0x07,0x0C,0x08,0x08,0x08,0x08,0x04,0x06,0xE1,0x7F,0x1F,0x00,0x00,
	0x00,0x00,0x07,0x07,0x08,0x08,0x08,0x08,0x0C,0x06,0x03,0x01,0x00,0x00,0x00,0x00/*"9",9*/
};

const uint8_t num10[] = {

	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x06,0x0F,0x0F,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00/*".",10*/
};

const uint8_t num11[] = {

	0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0xC0,0x7C,0x03,0x03,0x3F,0xFC,0x80,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x80,0x7C,0x0F,0x08,0x08,0x08,0x08,0x0B,0x7F,0xF8,0x80,0x00,0x00,0x00,
	0x08,0x0C,0x0F,0x08,0x08,0x00,0x00,0x00,0x00,0x00,0x08,0x0F,0x0F,0x0C,0x08,0x00/*"A",11*/
};

const uint8_t num12[] = {

	0x00,0x80,0xC0,0x40,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0xC0,0x00,0x00,0x00,0x00,
	0x7E,0xFF,0x00,0x00,0x00,0xFF,0x7E,0x00,0xE0,0x1C,0x03,0x00,0x00,0x00,0x00,0x00,
	0x00,0x01,0x03,0x02,0x83,0x61,0x1C,0x03,0xF8,0xFE,0x03,0x01,0x03,0xFE,0xF8,0x00,
	0x00,0x00,0x00,0x0C,0x03,0x00,0x00,0x00,0x01,0x07,0x0C,0x08,0x0C,0x07,0x01,0x00/*"%",11*/
};

const uint8_t num13[] = {

	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00/*"%",11*/
};

uint8_t* intToFloat(uint16_t data) {
	static uint8_t floatTemp[5];
	if (data<1000)
	{
		floatTemp[0] = (data / 100) % 10 + 48;
		floatTemp[1] = (data / 10) % 10 + 48;
		floatTemp[2] = '.';
		floatTemp[3] = data % 10 + 48;
		floatTemp[4] = '\0';
	}
	else
	{
		floatTemp[0] = ' ';
		floatTemp[1] = (data / 1000) % 10 + 48;
		floatTemp[2] = (data / 100) % 10 + 48;
		floatTemp[3] = (data / 10) % 10 + 48;
		floatTemp[4] = '\0';
	}
	
	return floatTemp;
}


void display_16X32_string(uint8_t page,uint8_t column,uint8_t *dp) {

	uint8_t i = 0;
	while (dp[i]!='\0')
	{
		switch (dp[i])
		{
		case '0':
			display_graphic_16x32(page, column,   num0);
			break;
		case '1':
			display_graphic_16x32(page, column,   num1);
			break;
		case '2':
			display_graphic_16x32(page, column,  num2);
			break;
		case '3':
			display_graphic_16x32(page, column,   num3);
			break;
		case '4':
			display_graphic_16x32(page, column,  num4);
			break;
		case '5':
			display_graphic_16x32(page, column,  num5);
			break;
		case '6':
			display_graphic_16x32(page, column,  num6);
			break;
		case '7':
			display_graphic_16x32(page, column,  num7);
			break;
		case '8':
			display_graphic_16x32(page, column,  num8);
			break;
		case '9':
			display_graphic_16x32(page, column,  num9);
			break;
		case '.':
			display_graphic_16x32(page, column,  num10);
			break;
		case 'A':
			display_graphic_16x32(page, column,  num11);
			break;
		case '%':
			display_graphic_16x32(page, column,  num12);
			break;
		case ' ':
			display_graphic_16x32(page, column, num13);
			break;
		default:
			break;
		}
		column += 16;
		i++;
	}

}

void displayCurrent() {
	display_GB2312_string(1, 1, 1,"当前电流:");
	display_16X32_string(3, 24, intToFloat(humiCurrent));
	display_16X32_string(3, 88, "A");
	display_GB2312_string(7, 1, 1, "报警");
	display_GB2312_string(7, 33, 0, "电流");
	display_GB2312_string(7, 65, 1, "开度比例");
}

void displayWarning() {
	display_GB2312_string(1, 1, 1, "报警信息:");
	display_16X32_string(3, 16, " 0000 ");
	display_GB2312_string(7, 1, 0, "报警");
	display_GB2312_string(7, 33, 1, "电流开度比例");

}

void dispalyOpening() {
	display_GB2312_string(1, 1, 1, "加湿开度:");
	display_16X32_string(3, 24, intToFloat(humiOpening));
	display_16X32_string(3, 88, "%");
	display_GB2312_string(7, 1, 1, "报警电流");
	display_GB2312_string(7, 65, 0, "开度");
	display_GB2312_string(7, 97, 1, "比例");
}

void dispalyProportion() {
	display_GB2312_string(1, 1, 1, "能量比例:");
	display_16X32_string(3, 24, intToFloat(powerProportion));
	display_16X32_string(3, 88, "%");
	display_GB2312_string(7, 1, 1, "报警电流开度");
	display_GB2312_string(7, 97, 0, "比例");
}

void display() {

	if (powerOn == 1)
	{
		HAL_GPIO_WritePin(LCD_LEDA_GPIO_Port, LCD_LEDA_Pin, GPIO_PIN_RESET);
		HAL_GPIO_WritePin(LED1_GPIO_Port, LED1_Pin, GPIO_PIN_SET);

		switch (displayCount)
		{
		case 0:
			displayWarning();
			break;
		case 1:
			displayCurrent();
			break;
		case 2:
			dispalyOpening();
			break;
		case 3:
			dispalyProportion();
			break;
		default:
			break;
		}
		
		/*
		display_GB2312_string(1, 1, "当前电流:");
		display_GB2312_string(3, 1, "加湿开度:");
		display_GB2312_string(5, 1, "能量比例:");
		display_GB2312_string(1, 80, intToFloat(humiCurrent));
		display_GB2312_string(3, 80, intToFloat(humiOpening));
		display_GB2312_string(5, 80, intToFloat(powerProportion));
		display_GB2312_string(1, 112, "A");
		display_GB2312_string(3, 112, "%");
		display_GB2312_string(5, 112, "%");
		*/


	}
	else
	{
		clear_screen();
		HAL_GPIO_WritePin(LED1_GPIO_Port, LED1_Pin, GPIO_PIN_RESET);
		HAL_GPIO_WritePin(LCD_LEDA_GPIO_Port, LCD_LEDA_Pin, GPIO_PIN_SET);
	}

	
}

void key1ShortPress(void)
{

	if (powerOn == 0)
	{
		powerOn = 1;
	}
	else
	{
		powerOn = 0;
	}

	if (key[0] == 0)
	{
		key[0] = 1;
	}
	else {
		key[0] = 0;
	}
}

void key2ShortPress(void)
{
	displayCount--;
	if (displayCount < 0)
	{
		displayCount = 3;
	}

	if (key[1] == 0)
	{
		key[1] = 1;
	}
	else {
		key[1] = 0;
	}
}

void key3ShortPress(void)
{
	
	if (key[2] == 0)
	{
		key[2] = 1;
	}
	else {
		key[2] = 0;
	}
}

void key4ShortPress(void)
{
	displayCount++;
	if (displayCount > 3)
	{
		displayCount = 0;
	}

	if (key[3] == 0)
	{
		key[3] = 1;
	}
	else {
		key[3] = 0;
	}
}